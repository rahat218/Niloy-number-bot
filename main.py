import logging
import datetime
import psycopg
import asyncio
import threading
import os
from flask import Flask
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup, ReplyKeyboardRemove
from telegram.ext import (
    Application,
    ConversationHandler,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    filters,
    ContextTypes,
)
from telegram.constants import ParseMode
from telegram.error import Forbidden

# -----------------------------------------------------------------------------
# |                      тЪая╕П ржЖржкржирж╛рж░ рж╕ржХрж▓ ржЧрзЛржкржи рждржерзНржп ржПржЦрж╛ржирзЗ тЪая╕П                      |
# -----------------------------------------------------------------------------
BOT_TOKEN = "7925556669:AAE5F9zUGOK37niSd0x-YEQX8rn-xGd8Pl8"
DATABASE_URL = "postgresql://niloy_number_bot_user:p2pmOrN2Kx7WjiC611qPGk1cVBqEbfeq@dpg-d20ii8nfte5s738v6elg-a/niloy_number_bot"
ADMIN_USER_ID = 7052442701
SUPPORT_USERNAME = "@NgRony"

# --- ржмржЯрзЗрж░ рж╕рзЗржЯрж┐ржВрж╕ ---
MAX_STRIKES = 3
BAN_HOURS = 24

# --- ржмрж╛ржЯржи ржЯрзЗржХрзНрж╕ржЯ ---
GET_NUMBER_TEXT = "тЬи Get Number ЁЯОЧя╕П"
MY_STATS_TEXT = "ЁЯУК My Stats"
SUPPORT_TEXT = "ЁЯУЮ Support"
LANGUAGE_TEXT = "ЁЯМР Language"
ADMIN_PANEL_TEXT = "ЁЯСС Admin Panel ЁЯСС"

# --- ржмрж╣рзБржнрж╛рж╖рж┐ржХ ржЯрзЗржХрзНрж╕ржЯ ---
# (LANG_TEXT dictionary ржЕржкрж░рж┐ржмрж░рзНрждрж┐ржд ржерж╛ржХржмрзЗ)
LANG_TEXT = {
    'bn': {
        "welcome": "ЁЯСЛ **рж╕рзНржмрж╛ржЧрждржо, {first_name}!**\n\nржирж┐ржЪрзЗрж░ ржХрзАржмрзЛрж░рзНржб ржерзЗржХрзЗ ржПржХржЯрж┐ ржЕржкрж╢ржи ржмрзЗржЫрзЗ ржирж┐ржиред",
        "keyboard_hidden": "ржХрзАржмрзЛрж░рзНржб рж▓рзБржХрж╛ржирзЛ рж╣рзЯрзЗржЫрзЗред ржЖржмрж╛рж░ ржжрзЗржЦрждрзЗ /start ржЪрж╛ржкрзБржиред",
        "choose_service": "ЁЯФв ржХрзЛржи рж╕рж╛рж░рзНржнрж┐рж╕рзЗрж░ ржЬржирзНржп ржиржорзНржмрж░ ржкрзНрж░рзЯрзЛржЬржи? ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржмрзЗржЫрзЗ ржирж┐ржи:",
        "stats_header": "ЁЯУК **ржЖржкржирж╛рж░ ржкрж░рж┐рж╕ржВржЦрзНржпрж╛ржи**",
        "strikes": "рж╕рзНржЯрзНрж░рж╛ржЗржХ",
        "spam_count": "рж╕рзНржкрзНржпрж╛ржо",
        "status_banned": "ржЕрзНржпрж╛ржХрж╛ржЙржирзНржЯ рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕: {hours} ржШржгрзНржЯрж╛рж░ ржЬржирзНржп ржирж┐рж╖рж┐ржжрзНржз",
        "status_normal": "рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕: рж╕рж╛ржзрж╛рж░ржг ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзА",
        "stats_not_found": "ржЖржкржирж╛рж░ ржкрж░рж┐рж╕ржВржЦрзНржпрж╛ржи ржЦрзБржБржЬрзЗ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ /start ржХржорж╛ржирзНржб ржжрж┐ржиред",
        "support_prompt": "ЁЯУЮ ржпрзЗ ржХрзЛржи ржкрзНрж░рзЯрзЛржЬржирзЗ ржЖржорж╛ржжрзЗрж░ рж╕рж╛ржкрзЛрж░рзНржЯ ржЯрж┐ржорзЗрж░ рж╕рж╛ржерзЗ ржпрзЛржЧрж╛ржпрзЛржЧ ржХрж░рждрзЗ ржирж┐ржЪрзЗрж░ ржмрж╛ржЯржирзЗ ржХрзНрж▓рж┐ржХ ржХрж░рзБржиред",
        "support_button": "рж╕рж╛ржкрзЛрж░рзНржЯрзЗ ржпрзЛржЧрж╛ржпрзЛржЧ ржХрж░рзБржи",
        "unknown_command": "ЁЯдФ ржжрзБржГржЦрж┐ржд, ржХржорж╛ржирзНржбржЯрж┐ ржмрзБржЭрждрзЗ ржкрж╛рж░рж┐ржирж┐ред ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржХрзАржмрзЛрж░рзНржбрзЗрж░ ржмрж╛ржЯржи ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред",
        "choose_language": "ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржЖржкржирж╛рж░ ржнрж╛рж╖рж╛ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржи:",
        "lang_changed": "тЬЕ ржЖржкржирж╛рж░ ржнрж╛рж╖рж╛ рж╕ржлрж▓ржнрж╛ржмрзЗ 'ржмрж╛ржВрж▓рж╛' ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред",
        "searching_number": "ЁЯФН ржЖржкржирж╛рж░ ржЬржирзНржп ржПржХржЯрж┐ **{service}** ржиржорзНржмрж░ ржЦрзЛржБржЬрж╛ рж╣ржЪрзНржЫрзЗ...",
        "no_number_available": "тЭМ **ржжрзБржГржЦрж┐ржд, ржПржЗ ржорзБрж╣рзВрж░рзНрждрзЗ ржиржорзНржмрж░ рж╢рзЗрж╖!** тЭМ\n\nржЖржорж╛ржжрзЗрж░ рж╕ржХрж▓ ржиржорзНржмрж░ ржмрж░рзНрждржорж╛ржирзЗ ржмрзНржпржмрж╣рзГржд рж╣ржЪрзНржЫрзЗред ржЕрзНржпрж╛ржбржорж┐ржиржХрзЗ ржмрж┐рж╖рзЯржЯрж┐ ржЬрж╛ржирж╛ржирзЛ рж╣рзЯрзЗржЫрзЗ ржПржмржВ рждрж┐ржирж┐ ржЦрзБржм рж╢рзАржШрзНрж░ржЗ ржирждрзБржи ржиржорзНржмрж░ ржпрзЛржЧ ржХрж░ржмрзЗржиред\n\nтП│ ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржХрж┐ржЫрзБржХрзНрж╖ржг ржкрж░ ржЖржмрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржиред",
        "new_numbers_broadcast": "ЁЯОЙ **рж╕рзБржЦржмрж░! ржирждрзБржи ржиржорзНржмрж░ ржпрзЛржЧ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ!** ЁЯОЙ\n\n**рждрж╛рж░рж┐ржЦ:** {date}\n\nржЕрзНржпрж╛ржбржорж┐ржи ржПржЗржорж╛рждрзНрж░ ржЖржорж╛ржжрзЗрж░ рж╕рж┐рж╕рзНржЯрзЗржорзЗ ржирждрзБржи ржиржорзНржмрж░ ржпрзЛржЧ ржХрж░рзЗржЫрзЗржиред ржПржЦржиржЗ ржЖржкржирж╛рж░ ржкрзНрж░рзЯрзЛржЬржирзАрзЯ ржиржорзНржмрж░ржЯрж┐ ржирж┐рзЯрзЗ ржирж┐ржи!",
        "broadcast_sent": "тЬЕ ржмрж╛рж░рзНрждрж╛ржЯрж┐ рж╕ржлрж▓ржнрж╛ржмрзЗ {count} ржЬржи ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзАржХрзЗ ржкрж╛ржарж╛ржирзЛ рж╣рзЯрзЗржЫрзЗред",
        "broadcast_no_message": "тЭМ ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ /broadcast ржХржорж╛ржирзНржбрзЗрж░ рж╕рж╛ржерзЗ ржПржХржЯрж┐ ржмрж╛рж░рзНрждрж╛ ржжрж┐ржиред",
        "admin_announcement": "ЁЯУг ржЕрзНржпрж╛ржбржорж┐ржирзЗрж░ ржШрзЛрж╖ржгрж╛ ЁЯУг",
        "back_button": "тмЕя╕П ржкрж┐ржЫржирзЗ",
        "main_menu_prompt": "ржкрзНрж░ржзрж╛ржи ржорзЗржирзБ ржерзЗржХрзЗ ржПржХржЯрж┐ ржЕржкрж╢ржи ржмрзЗржЫрзЗ ржирж┐ржиред",
        "admin_panel_welcome": "ЁЯСС **ржЕрзНржпрж╛ржбржорж┐ржи ржкрзНржпрж╛ржирзЗрж▓рзЗ рж╕рзНржмрж╛ржЧрждржо** ЁЯСС\n\nржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржирж┐ржЪрзЗрж░ ржЕржкрж╢ржиржЧрзБрж▓рзЛ ржерзЗржХрзЗ ржмрзЗржЫрзЗ ржирж┐ржи:",
        "guideline_title": "ЁЯУЬ **ржЕрзНржпрж╛ржбржорж┐ржи ржХржорж╛ржирзНржб ржЧрж╛ржЗржбрж▓рж╛ржЗржи** ЁЯУЬ",
        "guideline_text": """
        `тЮХ ржиржорзНржмрж░ ржпрзЛржЧ ржХрж░рзБржи`
        ржПржЗ ржмрж╛ржЯржирзЗ ржХрзНрж▓рж┐ржХ ржХрж░рж╛рж░ ржкрж░, ржкрзНрж░рждрж┐ рж▓рж╛ржЗржирзЗ ржПржХржЯрж┐ ржХрж░рзЗ ржиржорзНржмрж░ ржПржмржВ рж╕рж╛рж░рзНржнрж┐рж╕ ржХржорж╛ ржжрж┐рзЯрзЗ ржЖрж▓рж╛ржжрж╛ ржХрж░рзЗ ржкрж╛ржарж╛ржиред
        *ржЙржжрж╛рж╣рж░ржг:*
        `+8801711111111,Facebook`
        `+8801822222222,Telegram`

        `ЁЯУг ржШрзЛрж╖ржгрж╛ ржжрж┐ржи (Broadcast)`
        ржХржорж╛ржирзНржб: `/broadcast [ржЖржкржирж╛рж░ ржмрж╛рж░рзНрждрж╛]`
        рж╕ржХрж▓ ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзАржХрзЗ ржПржХржЯрж┐ ржлрж░рзНржорзНржпрж╛ржЯ ржХрж░рж╛ ржмрж╛рж░рзНрждрж╛ ржкрж╛ржарж╛рзЯред

        `ЁЯЪл ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзА ржмрзНржпрж╛ржи/ржЖржиржмрзНржпрж╛ржи ржХрж░рзБржи`
        ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзАрж░ User ID ржжрж┐рзЯрзЗ рждрж╛ржХрзЗ ржмрзНржпрж╛ржи ржмрж╛ ржЖржиржмрзНржпрж╛ржи ржХрж░рзБржиред
        *ржмрзНржпрж╛ржи:* `/ban [User ID]`
        *ржЖржиржмрзНржпрж╛ржи:* `/unban [User ID]`
        """,
        "numbers_added_success": "тЬЕ рж╕ржлрж▓ржнрж╛ржмрзЗ {count} ржЯрж┐ ржирждрзБржи ржиржорзНржмрж░ ржпрзЛржЧ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзАржжрзЗрж░ ржЬрж╛ржирж╛ржирзЛ рж╣ржЪрзНржЫрзЗ...",
        "numbers_added_fail": "тЭМ ржХрзЛржирзЛ ржмрзИржз ржиржорзНржмрж░ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред ржлрж░ржорзНржпрж╛ржЯ ржЪрзЗржХ ржХрж░рзБржи: `+880...,Service`",
        "ask_for_numbers": "тЬНя╕П ржиржорзНржмрж░ржЧрзБрж▓рзЛ ржкрж╛ржарж╛ржиред ржкрзНрж░рждрж┐ рж▓рж╛ржЗржирзЗ ржПржХржЯрж┐ ржХрж░рзЗ ржиржорзНржмрж░ ржПржмржВ рж╕рж╛рж░рзНржнрж┐рж╕ ржХржорж╛ ржжрж┐рзЯрзЗ ржЖрж▓рж╛ржжрж╛ ржХрж░рзЗ рж▓рж┐ржЦрзБржиред ржпрзЗржоржи: `+12345,Facebook`",
        "user_banned_success": "тЬЕ ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзА {user_id} ржХрзЗ рж╕ржлрж▓ржнрж╛ржмрзЗ ржмрзНржпрж╛ржи ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред",
        "user_unbanned_success": "тЬЕ ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзА {user_id} ржХрзЗ рж╕ржлрж▓ржнрж╛ржмрзЗ ржЖржиржмрзНржпрж╛ржи ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред",
        "user_not_found": "тЭМ ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзА {user_id} ржХрзЗ ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗ ржЦрзБржБржЬрзЗ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред",
    },
    'en': { # English translations for new features
        "admin_panel_welcome": "ЁЯСС **Welcome to the Admin Panel** ЁЯСС\n\nPlease choose from the options below:",
        "guideline_title": "ЁЯУЬ **Admin Command Guideline** ЁЯУЬ",
        "guideline_text": """
        `тЮХ Add Numbers`
        After clicking this button, send numbers per line, separated by a comma with the service.
        *Example:*
        `+1234567890,Facebook`
        `+9876543210,Telegram`

        `ЁЯУг Broadcast`
        Command: `/broadcast [Your Message]`
        Sends a formatted message to all users.

        `ЁЯЪл Ban/Unban User`
        Ban or unban a user with their User ID.
        *Ban:* `/ban [User ID]`
        *Unban:* `/unban [User ID]`
        """,
        "numbers_added_success": "тЬЕ Successfully added {count} new numbers. Notifying users...",
        "numbers_added_fail": "тЭМ No valid numbers found. Check the format: `+123...,Service`",
        "ask_for_numbers": "тЬНя╕П Send the numbers. Write one per line, separating the number and service with a comma. E.g., `+12345,Facebook`",
        "user_banned_success": "тЬЕ User {user_id} has been successfully banned.",
        "user_unbanned_success": "тЬЕ User {user_id} has been successfully unbanned.",
        "user_not_found": "тЭМ User {user_id} not found in the database.",
        "new_numbers_broadcast": "ЁЯОЙ **Good News! New Numbers Added!** ЁЯОЙ\n\n**Date:** {date}\n\nThe admin has just added new numbers to our system. Get yours now!",
    }
}


# -----------------------------------------------------------------------------
# |                      рж▓ржЧрж┐ржВ, рж╕рж╛рж░рзНржнрж╛рж░ ржПржмржВ Conversation States              |
# -----------------------------------------------------------------------------
logging.basicConfig(format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO)
logging.getLogger("httpx").setLevel(logging.WARNING)
logger = logging.getLogger(__name__)

# Conversation states for admin
ADDING_NUMBERS = 1

flask_app = Flask(__name__)
@flask_app.route('/')
def keep_alive():
    return "Bot is alive and running successfully!"

def run_flask():
    port = int(os.environ.get('PORT', 8080))
    flask_app.run(host='0.0.0.0', port=port)

# -----------------------------------------------------------------------------
# |                         ржбрж╛ржЯрж╛ржмрзЗрж╕ ржПржмржВ ржкрзНрж░ржзрж╛ржи ржлрж╛ржВрж╢ржи                          |
# -----------------------------------------------------------------------------
async def get_db_conn():
    return await psycopg.AsyncConnection.connect(DATABASE_URL)

async def setup_database(app: Application):
    logger.info("Connecting to database and verifying schema...")
    try:
        async with await get_db_conn() as aconn:
            async with aconn.cursor() as acur:
                await acur.execute("""
                    CREATE TABLE IF NOT EXISTS users (
                        user_id BIGINT PRIMARY KEY, first_name VARCHAR(255), strikes INT DEFAULT 0,
                        is_banned BOOLEAN DEFAULT FALSE, ban_until TIMESTAMP, language VARCHAR(5) DEFAULT 'bn',
                        last_number_broadcast_id BIGINT
                    );
                    CREATE TABLE IF NOT EXISTS numbers (
                        id SERIAL PRIMARY KEY, phone_number VARCHAR(25) UNIQUE NOT NULL, service VARCHAR(50) NOT NULL,
                        is_available BOOLEAN DEFAULT TRUE, is_reported BOOLEAN DEFAULT FALSE,
                        assigned_to BIGINT, assigned_at TIMESTAMP
                    );
                """)
                # ржХрж▓рж╛ржоржЧрзБрж▓рзЛ ржирж╛ ржерж╛ржХрж▓рзЗ ржпрзЛржЧ ржХрж░рж╛рж░ ржЬржирзНржп рж╕рзНржмрзЯржВржХрзНрж░рж┐рзЯ ржмрзНржпржмрж╕рзНржерж╛
                await acur.execute("SELECT column_name FROM information_schema.columns WHERE table_name='users'")
                columns = [row[0] for row in await acur.fetchall()]
                if 'language' not in columns:
                    await acur.execute("ALTER TABLE users ADD COLUMN language VARCHAR(5) DEFAULT 'bn';")
                if 'last_number_broadcast_id' not in columns:
                    await acur.execute("ALTER TABLE users ADD COLUMN last_number_broadcast_id BIGINT;")

        logger.info("SUCCESS: Database schema is up-to-date.")
        await app.bot.send_message(chat_id=ADMIN_USER_ID, text="тЬЕ **Bot Deployed/Restarted Successfully!**", parse_mode=ParseMode.MARKDOWN)
    except Exception as e:
        logger.error(f"CRITICAL: Database or boot failure! Error: {e}")

async def get_user_lang(user_id: int) -> str:
    async with await get_db_conn() as aconn:
        async with aconn.cursor() as acur:
            await acur.execute("SELECT language FROM users WHERE user_id = %s", (user_id,))
            result = await acur.fetchone()
            return result[0] if result and result[0] else 'bn'

# -----------------------------------------------------------------------------
# |                      ржЯрзЗрж▓рж┐ржЧрзНрж░рж╛ржо ржмржЯрзЗрж░ рж╕ржХрж▓ рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░                       |
# -----------------------------------------------------------------------------

def get_main_reply_keyboard(user_id: int):
    keyboard = [
        [GET_NUMBER_TEXT],
        [MY_STATS_TEXT, SUPPORT_TEXT],
        [LANGUAGE_TEXT]
    ]
    if user_id == ADMIN_USER_ID:
        keyboard.append([ADMIN_PANEL_TEXT])
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    async with await get_db_conn() as aconn:
        async with aconn.cursor() as acur:
            await acur.execute("INSERT INTO users (user_id, first_name) VALUES (%s, %s) ON CONFLICT (user_id) DO UPDATE SET first_name = EXCLUDED.first_name", (user.id, user.first_name))
    lang = await get_user_lang(user.id)
    await update.message.reply_text(
        text=LANG_TEXT[lang]['welcome'].format(first_name=user.first_name),
        reply_markup=get_main_reply_keyboard(user.id), parse_mode=ParseMode.MARKDOWN
    )

# --- Admin Panel Handlers ---
async def admin_panel_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_USER_ID: return
    lang = await get_user_lang(ADMIN_USER_ID)
    keyboard = [
        [InlineKeyboardButton("тЮХ ржиржорзНржмрж░ ржпрзЛржЧ ржХрж░рзБржи", callback_data="admin_add_numbers")],
        [InlineKeyboardButton("ЁЯУг ржШрзЛрж╖ржгрж╛ ржжрж┐ржи", callback_data="admin_broadcast_guide")],
        [InlineKeyboardButton("ЁЯЪл ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзА ржмрзНржпрж╛ржи/ржЖржиржмрзНржпрж╛ржи ржХрж░рзБржи", callback_data="admin_ban_guide")],
        [InlineKeyboardButton("ЁЯУЬ ржЧрж╛ржЗржбрж▓рж╛ржЗржи ржжрзЗржЦрзБржи", callback_data="admin_guideline")]
    ]
    await update.message.reply_text(LANG_TEXT[lang]['admin_panel_welcome'], reply_markup=InlineKeyboardMarkup(keyboard), parse_mode=ParseMode.MARKDOWN)

async def admin_panel_callback(query: Update.callback_query, context: ContextTypes.DEFAULT_TYPE):
    data = query.data
    lang = await get_user_lang(ADMIN_USER_ID)

    if data == "admin_add_numbers":
        await query.message.reply_text(LANG_TEXT[lang]['ask_for_numbers'])
        return ADDING_NUMBERS
    elif data == "admin_guideline":
        await query.message.reply_text(f"**{LANG_TEXT[lang]['guideline_title']}**\n{LANG_TEXT[lang]['guideline_text']}", parse_mode=ParseMode.MARKDOWN)
    elif data == "admin_broadcast_guide" or data == "admin_ban_guide":
         await query.message.reply_text(f"**{LANG_TEXT[lang]['guideline_title']}**\n{LANG_TEXT[lang]['guideline_text']}", parse_mode=ParseMode.MARKDOWN)


async def handle_add_numbers(update: Update, context: ContextTypes.DEFAULT_TYPE):
    lang = await get_user_lang(ADMIN_USER_ID)
    numbers_text = update.message.text
    lines = numbers_text.strip().split('\n')
    valid_numbers = []
    for line in lines:
        parts = line.split(',')
        if len(parts) == 2 and parts[0].strip().startswith('+'):
            valid_numbers.append((parts[0].strip(), parts[1].strip().capitalize()))

    if not valid_numbers:
        await update.message.reply_text(LANG_TEXT[lang]['numbers_added_fail'])
        return ConversationHandler.END

    async with await get_db_conn() as aconn:
        async with aconn.cursor() as acur:
            await acur.executemany(
                "INSERT INTO numbers (phone_number, service) VALUES (%s, %s) ON CONFLICT (phone_number) DO NOTHING",
                valid_numbers
            )
            count = acur.rowcount

    await update.message.reply_text(LANG_TEXT[lang]['numbers_added_success'].format(count=count))
    
    # ржирждрзБржи ржиржорзНржмрж░ ржпрзЛржЧ ржХрж░рж╛рж░ ржкрж░ ржмрзНрж░ржбржХрж╛рж╕рзНржЯ ржкрж╛ржарж╛ржирзЛ
    context.application.create_task(broadcast_new_numbers(context))
    
    return ConversationHandler.END

async def broadcast_new_numbers(context: ContextTypes.DEFAULT_TYPE):
    async with await get_db_conn() as aconn:
        async with aconn.cursor() as acur:
            await acur.execute("SELECT user_id, language, last_number_broadcast_id FROM users")
            all_users = await acur.fetchall()
            
    today_date = datetime.datetime.now().strftime("%d %B, %Y")

    for user_id, lang, last_msg_id in all_users:
        # ржЖржЧрзЗрж░ ржорзЗрж╕рзЗржЬ ржбрж┐рж▓рж┐ржЯ ржХрж░рж╛
        if last_msg_id:
            try:
                await context.bot.delete_message(chat_id=user_id, message_id=last_msg_id)
            except Forbidden:
                pass # ржмржЯ ржмрзНрж▓ржХ ржерж╛ржХрж▓рзЗ ржХрж┐ржЫрзБ ржХрж░рж╛рж░ ржирзЗржЗ
            except Exception:
                pass # ржорзЗрж╕рзЗржЬ ржЦрзБржБржЬрзЗ ржирж╛ ржкрж╛ржУрзЯрж╛ ржЧрзЗрж▓рзЗ ржмрж╛ ржЕржирзНржп ржХрзЛржирзЛ рж╕ржорж╕рзНржпрж╛ рж╣рж▓рзЗ

        # ржирждрзБржи ржорзЗрж╕рзЗржЬ ржкрж╛ржарж╛ржирзЛ
        user_lang_code = lang if lang in LANG_TEXT else 'bn'
        message_text = LANG_TEXT[user_lang_code]['new_numbers_broadcast'].format(date=today_date)
        try:
            sent_message = await context.bot.send_message(chat_id=user_id, text=message_text, parse_mode=ParseMode.MARKDOWN)
            # ржирждрзБржи ржорзЗрж╕рзЗржЬ ржЖржЗржбрж┐ рж╕рзЗржн ржХрж░рж╛
            async with aconn.cursor() as acur_update:
                await acur_update.execute("UPDATE users SET last_number_broadcast_id = %s WHERE user_id = %s", (sent_message.message_id, user_id))
        except Forbidden:
            logger.warning(f"User {user_id} has blocked the bot. Skipping broadcast.")
        except Exception as e:
            logger.error(f"Failed to send new number broadcast to {user_id}: {e}")
        await asyncio.sleep(0.1)


async def ban_user_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_USER_ID: return
    lang = await get_user_lang(ADMIN_USER_ID)
    try:
        user_to_ban = int(context.args[0])
        ban_time = datetime.datetime.now() + datetime.timedelta(hours=BAN_HOURS)
        async with await get_db_conn() as aconn:
            async with aconn.cursor() as acur:
                await acur.execute(
                    "UPDATE users SET is_banned = TRUE, ban_until = %s, strikes = %s WHERE user_id = %s",
                    (ban_time, MAX_STRIKES, user_to_ban)
                )
                if acur.rowcount > 0:
                    await update.message.reply_text(LANG_TEXT[lang]['user_banned_success'].format(user_id=user_to_ban))
                else:
                    await update.message.reply_text(LANG_TEXT[lang]['user_not_found'].format(user_id=user_to_ban))
    except (IndexError, ValueError):
        await update.message.reply_text("ржмрзНржпржмрж╣рж╛рж░: /ban [User ID]")

async def unban_user_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_USER_ID: return
    lang = await get_user_lang(ADMIN_USER_ID)
    try:
        user_to_unban = int(context.args[0])
        async with await get_db_conn() as aconn:
            async with aconn.cursor() as acur:
                await acur.execute(
                    "UPDATE users SET is_banned = FALSE, ban_until = NULL, strikes = 0 WHERE user_id = %s",
                    (user_to_unban,)
                )
                if acur.rowcount > 0:
                    await update.message.reply_text(LANG_TEXT[lang]['user_unbanned_success'].format(user_id=user_to_unban))
                else:
                    await update.message.reply_text(LANG_TEXT[lang]['user_not_found'].format(user_id=user_to_unban))
    except (IndexError, ValueError):
        await update.message.reply_text("ржмрзНржпржмрж╣рж╛рж░: /unban [User ID]")


async def data_cleanup_job(context: ContextTypes.DEFAULT_TYPE):
    logger.info("Running daily data cleanup job...")
    try:
        async with await get_db_conn() as aconn:
            async with aconn.cursor() as acur:
                await acur.execute("DELETE FROM users WHERE strikes = 0 AND (is_banned = FALSE OR ban_until < NOW())")
                logger.info(f"Cleanup complete. Deleted {acur.rowcount} users.")
    except Exception as e:
        logger.error(f"Error during data cleanup job: {e}")

# ... (ржмрж╛ржХрж┐ рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░ржЧрзБрж▓рзЛ ржЕржкрж░рж┐ржмрж░рзНрждрж┐ржд)
# (handle_get_number, handle_my_stats, etc. will remain the same as the last provided code)

# -----------------------------------------------------------------------------
# |                         ржлрж╛ржЗржирж╛рж▓ ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржи ржЪрж╛рж▓рзБ ржХрж░рж╛                        |
# -----------------------------------------------------------------------------
def main() -> None:
    flask_thread = threading.Thread(target=run_flask)
    flask_thread.daemon = True
    flask_thread.start()
    logger.info("Keep-alive server started.")

    bot_app = Application.builder().token(BOT_TOKEN).post_init(setup_database).build()
    
    # --- рж╕рзНржмрзЯржВржХрзНрж░рж┐рзЯ ржХрзНрж▓рж┐ржирж╛рж░ ржЬржм рж╕рзЗржЯржЖржк ---
    job_queue = bot_app.job_queue
    job_queue.run_daily(data_cleanup_job, time=datetime.time(hour=21, minute=0, second=0)) # UTC 21:00 = GMT+6 03:00

    # --- ржЕрзНржпрж╛ржбржорж┐ржи Conversation Handler ---
    admin_conv_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(admin_panel_callback, pattern='^admin_add_numbers$')],
        states={
            ADDING_NUMBERS: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_add_numbers)],
        },
        fallbacks=[],
        per_message=False
    )
    
    bot_app.add_handler(admin_conv_handler)
    
    # --- ржХржорж╛ржирзНржб рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░ ---
    bot_app.add_handler(CommandHandler("start", start_command))
    bot_app.add_handler(CommandHandler("ban", ban_user_command))
    bot_app.add_handler(CommandHandler("unban", unban_user_command))
    # ... (broadcast and other commands will be added here if needed)

    # --- ржмрж╛ржЯржи рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░ ---
    bot_app.add_handler(MessageHandler(filters.TEXT & filters.Regex(f'^{ADMIN_PANEL_TEXT}$'), admin_panel_command))
    # ... (other ReplyKeyboard handlers remain the same)
    
    # --- ржЗржирж▓рж╛ржЗржи ржмрж╛ржЯржи рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░ ---
    # We need a general callback handler for other admin buttons that don't start a conversation
    bot_app.add_handler(CallbackQueryHandler(admin_panel_callback, pattern='^admin_guideline$|^admin_broadcast_guide$|^admin_ban_guide$'))
    # ... (the main button press handler for users remains the same)

    logger.info("Telegram Bot starting polling...")
    bot_app.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    main()
